#ospf #routing #network-layer #control-plane #computer-network #link-state #backend #site-reliability-engineering

# Open Shortest Path First (OSPF)

## Overview
- ==Intra-Autonomous System== (intra-AS) routing protocol
- ==Link-state protocol== using Dijkstra's shortest path algorithm
- Operates directly over ==IP protocol 89== (not TCP/UDP)
- Fast convergence, hierarchical design, supports ==multicast== for efficient updates
- Critical for enterprise campus networks, datacenter fabrics, and service provider core

## OSPF vs BGP

| Feature | OSPF | BGP |
|---------|------|-----|
| **Scope** | Intra-AS (within organization) | Inter-AS (between organizations) |
| **Algorithm** | Link-state (Dijkstra SPF) | Path-vector |
| **Metric** | Cost (bandwidth-based) | AS_PATH, LOCAL_PREF, MED |
| **Convergence** | Fast (seconds) | Slow (minutes) |
| **Scalability** | Limited (thousands of routes) | Massive (millions of routes) |
| **Use case** | Enterprise, datacenter | Internet routing, multi-cloud |

## OSPF Packet Types

| Type | Name | Purpose | Destination |
|------|------|---------|-------------|
| 1 | **Hello** | Neighbor discovery, keepalive | 224.0.0.5 (AllSPFRouters) |
| 2 | **DBD** (Database Description) | Summarize LSDB during adjacency | Unicast |
| 3 | **LSR** (Link-State Request) | Request specific LSAs | Unicast |
| 4 | **LSU** (Link-State Update) | Send LSAs (topology changes) | 224.0.0.5 or unicast |
| 5 | **LSAck** (Link-State Acknowledgment) | Acknowledge received LSAs | Unicast or multicast |

## OSPF Neighbor States

### Adjacency Formation Process
```
Down → Init → 2-Way → ExStart → Exchange → Loading → Full
```

| State | Description | Next Action |
|-------|-------------|-------------|
| **Down** | No Hello received | Send Hello |
| **Init** | Hello received, but not seeing own Router ID | Wait for 2-Way |
| **2-Way** | Bidirectional communication established | Elect DR/BDR (if broadcast) |
| **ExStart** | Master/slave election for DBD exchange | Send DBD |
| **Exchange** | Exchange Database Description packets | Send LSR if needed |
| **Loading** | Request and receive missing LSAs | Send LSR/LSU |
| **Full** | LSDB synchronized, adjacency complete | Calculate SPF |

### DR/BDR Election (Broadcast Networks)
- ==Designated Router== (DR): Centralized LSA distribution on broadcast networks
- ==Backup Designated Router== (BDR): Redundancy for DR
- **Election criteria**: Highest priority (1-255, default 1), then highest Router ID
- **DRother routers**: Form adjacency only with DR/BDR (reduces n² adjacencies to 2n)

```
Broadcast network (Ethernet)
┌──────────────────────────────────┐
│  R1 (DRother) ←──→ DR (R3)       │
│  R2 (DRother) ←──→ BDR (R4)      │
│  R5 (DRother)                    │
│                                  │
│  Full adjacency:                 │
│  - DR ←→ All routers             │
│  - BDR ←→ All routers            │
│  - DRothers remain in 2-Way      │
└──────────────────────────────────┘
```

## OSPF LSA Types

### Common LSA Types
| Type | Name | Generated By | Flooded Within | Purpose |
|------|------|--------------|----------------|---------|
| 1 | **Router LSA** | All routers | Area only | Router's links and costs |
| 2 | **Network LSA** | DR | Area only | Multi-access network info |
| 3 | **Summary LSA** | ABR | From one area to another | Inter-area routes |
| 4 | **ASBR Summary LSA** | ABR | Throughout AS | Location of ASBR |
| 5 | **AS External LSA** | ASBR | Throughout AS (except stub) | External routes (BGP, static) |
| 7 | **NSSA External LSA** | ASBR in NSSA | NSSA only | External routes in NSSA |

### LSA Propagation Example
```
Area 0 (Backbone)
┌────────────────────────────────┐
│  ABR1 ←→ R1 ←→ R2 ←→ ABR2      │  Type 1, 2 LSAs
└────────────────────────────────┘
     ↑                      ↑
     │ Type 3 Summary LSAs │
     ↓                      ↓
Area 1              Area 2
┌──────────┐      ┌──────────┐
│ R3 ←→ R4 │      │ R5 ←→ R6 │
└──────────┘      └──────────┘
```

## Hierarchical OSPF

### Area Types

#### Area 0 (Backbone)
- ==Mandatory backbone area==
- All areas must connect to Area 0
- **Routers**: Backbone routers, ABRs, ASBRs
- Distributes inter-area routes

#### Regular Areas
- Standard OSPF areas with all LSA types
- **Use case**: Departmental networks, branch offices

#### Stub Area
- Blocks ==Type 5 External LSAs==
- ABR injects default route (0.0.0.0/0)
- **Use case**: Reduce routing table size in branches

#### Totally Stubby Area (Cisco proprietary)
- Blocks ==Type 3, 4, 5 LSAs==
- Only default route from ABR
- **Use case**: Very small branch offices

#### Not-So-Stubby Area (NSSA)
- Allows ==Type 7 LSAs== (converted to Type 5 at ABR)
- Supports redistribution from NSSA into OSPF
- **Use case**: Branch with external connectivity

### Area Design Best Practices
```
Internet
   ↓
ASBR (redistributes BGP)
   ↓
┌─────────────────────────────────────┐
│       Area 0 (Backbone)             │
│  ABR1 ←→ Backbone Routers ←→ ABR2   │
└─────────────────────────────────────┘
   ↑           ↑           ↑
   │           │           │
 Area 1      Area 2      Area 10 (Stub)
 ┌─────┐    ┌─────┐     ┌─────┐
 │ LAN │    │ LAN │     │ LAN │
 └─────┘    └─────┘     └─────┘
```

**Design Guidelines:**
- Keep Area 0 stable (core infrastructure)
- Limit routers per area to 50-100 for scalability
- Use stub areas at network edge
- Summarize routes at ABRs

## OSPF Configuration

### Basic OSPF Setup (Cisco IOS)
```bash
# Enable OSPF process 1
router ospf 1
 router-id 1.1.1.1

# Advertise networks in specific areas
 network 10.0.1.0 0.0.0.255 area 0
 network 10.0.2.0 0.0.0.255 area 1

# Passive interface (don't send Hello packets)
 passive-interface GigabitEthernet0/0

# Adjust interface cost
interface GigabitEthernet0/1
 ip ospf cost 10
```

### OSPF Authentication
```bash
# Area-based authentication (MD5)
router ospf 1
 area 0 authentication message-digest

interface GigabitEthernet0/1
 ip ospf message-digest-key 1 md5 SecurePassword123
```

### OSPF on Linux (FRRouting)
```bash
# Install FRRouting
apt-get install frr

# Configure OSPF
vtysh
configure terminal

router ospf
 ospf router-id 1.1.1.1
 network 10.0.1.0/24 area 0
 network 10.0.2.0/24 area 1

interface eth0
 ip ospf cost 10
 ip ospf hello-interval 5
 ip ospf dead-interval 20
```

## OSPF in Cloud Environments

### AWS (Limited OSPF Support)
- **VPC**: No native OSPF support (use BGP with Transit Gateway)
- **Transit Gateway**: Supports BGP, not OSPF
- **Workaround**: Run OSPF on EC2 instances with FRRouting

```bash
# EC2 instance with FRRouting
sudo apt install frr
sudo systemctl enable frr
sudo systemctl start frr

# Configure OSPF between EC2 instances
vtysh -c 'configure terminal' \
      -c 'router ospf' \
      -c 'network 10.0.0.0/16 area 0'
```

### GCP Cloud Router (No OSPF)
- **Cloud Router**: BGP only, no OSPF support
- **Alternative**: Use iBGP within VPC, eBGP for interconnects

### Azure (ExpressRoute supports OSPF indirectly)
- **Azure Virtual Network**: No native OSPF
- **ExpressRoute**: Use BGP for peering
- **Workaround**: OSPF on VMs with NVA (Network Virtual Appliances)

### On-Premises Integration
```
On-Premises OSPF ←→ Edge Router (OSPF/BGP) ←→ Cloud (BGP)
```

**Best practice**: Use OSPF within datacenter/campus, redistribute into BGP at edge for cloud connectivity

## OSPF Monitoring & Troubleshooting

### Verify OSPF Neighbors
```bash
# Cisco IOS
show ip ospf neighbor

# Example output
Neighbor ID     Pri   State           Dead Time   Address         Interface
2.2.2.2           1   FULL/DR         00:00:35    10.0.1.2        Gi0/1
3.3.3.3           1   FULL/BDR        00:00:33    10.0.1.3        Gi0/1

# FRRouting
vtysh -c 'show ip ospf neighbor'
```

### Check OSPF Database
```bash
# View LSDB
show ip ospf database

# Check specific LSA type
show ip ospf database router
show ip ospf database network
show ip ospf database summary

# Verify LSA details
show ip ospf database router 1.1.1.1
```

### Check OSPF Routes
```bash
# Cisco IOS
show ip route ospf

# FRRouting
vtysh -c 'show ip route ospf'

# Example output
O       10.0.2.0/24 [110/20] via 10.0.1.2, 00:05:23, GigabitEthernet0/1
O IA    10.0.3.0/24 [110/30] via 10.0.1.3, 00:03:12, GigabitEthernet0/1
O E2    0.0.0.0/0 [110/1] via 10.0.1.1, 00:10:45, GigabitEthernet0/0

# O = OSPF intra-area
# O IA = OSPF inter-area (Type 3 LSA)
# O E1 = External Type 1 (cost = external + internal)
# O E2 = External Type 2 (cost = external only)
```

### Common OSPF Issues

#### Issue 1: Neighbors Stuck in Init/2-Way State
```bash
# Symptoms
Router# show ip ospf neighbor
Neighbor ID     Pri   State           Dead Time   Address         Interface
2.2.2.2           1   INIT            00:00:35    10.0.1.2        Gi0/1

# Causes
1. MTU mismatch between neighbors
2. Mismatched OSPF network types
3. Access-list blocking OSPF multicast (224.0.0.5)
4. Duplicate Router IDs

# Diagnosis
show ip ospf interface Gi0/1 | include MTU
show ip ospf interface Gi0/1 | include Network Type
ping 224.0.0.5

# Solution
interface GigabitEthernet0/1
 ip mtu 1500
 ip ospf network broadcast
```

#### Issue 2: Neighbors Stuck in ExStart
```bash
# Symptoms
Router# show ip ospf neighbor
Neighbor ID     Pri   State           Dead Time   Address         Interface
2.2.2.2           1   EXSTART         00:00:35    10.0.1.2        Gi0/1

# Cause: MTU mismatch (most common)

# Diagnosis
show interface Gi0/1 | include MTU
# Neighbor: MTU = 1500
# Local: MTU = 9000 (jumbo frames)

# Solution (match MTU or disable MTU checking)
interface GigabitEthernet0/1
 ip mtu 1500

# Or disable MTU checking (not recommended)
 ip ospf mtu-ignore
```

#### Issue 3: Missing Routes
```bash
# Symptoms
Router# show ip route 10.0.5.0
% Network not in table

# Diagnosis
1. Check if route in OSPF database
   show ip ospf database | include 10.0.5.0

2. Verify ABR is advertising Summary LSA
   show ip ospf database summary | include 10.0.5.0

3. Check area configuration
   show ip ospf interface brief

4. Verify no filtering at ABR
   show ip prefix-list
   show route-map

# Solution
# Ensure area 0 connectivity (all areas must connect to Area 0)
# Check if route is filtered by distribute-list or route-map
router ospf 1
 no distribute-list 10 in
```

#### Issue 4: OSPF Flapping
```bash
# Symptoms
Router# show ip ospf neighbor
Neighbor ID     Pri   State           Dead Time   Address         Interface
2.2.2.2           1   FULL/DR         00:00:08    10.0.1.2        Gi0/1
# (neighbor goes Down/Up repeatedly)

# Causes
1. Physical link instability
2. Hello/Dead timer mismatch
3. CPU/memory exhaustion
4. Mismatched authentication

# Diagnosis
show ip ospf interface Gi0/1 | include Timer
# Hello 10, Dead 40
# Neighbor must match: Hello 10, Dead 40

show processes cpu sorted
show memory

# Solution - Increase timers for stability
interface GigabitEthernet0/1
 ip ospf hello-interval 10
 ip ospf dead-interval 40
```

## OSPF Performance Tuning

### Adjust Timers
```bash
# Default: Hello=10s, Dead=40s (broadcast/P2P)
# Faster convergence (use with caution)
interface GigabitEthernet0/1
 ip ospf hello-interval 1
 ip ospf dead-interval 4

# Slower for stability on unreliable links
interface GigabitEthernet0/1
 ip ospf hello-interval 30
 ip ospf dead-interval 120
```

### Cost Tuning
```bash
# OSPF cost = reference-bandwidth / interface-bandwidth
# Default reference-bandwidth = 100 Mbps

# Adjust reference bandwidth for 10G/100G links
router ospf 1
 auto-cost reference-bandwidth 100000  # 100 Gbps

# Manual cost override
interface GigabitEthernet0/1
 ip ospf cost 5
```

### Summarization at ABR
```bash
# Reduce Type 3 LSAs by summarizing routes
router ospf 1
 area 1 range 10.0.0.0 255.255.0.0
 # Summarizes 10.0.x.x networks into single 10.0.0.0/16

# External route summarization at ASBR
 summary-address 192.168.0.0 255.255.0.0
```

### Reduce SPF Calculations
```bash
# Throttle SPF computation (avoid CPU spikes during flaps)
router ospf 1
 timers throttle spf 5000 10000 20000
 # Initial delay: 5s, incremental delay: 10s, max delay: 20s
```

## OSPF Security Best Practices

### 1. Authentication (Prevent Rogue Routers)
```bash
# Area-based MD5 authentication
router ospf 1
 area 0 authentication message-digest

interface GigabitEthernet0/1
 ip ospf message-digest-key 1 md5 StrongPassword123
```

### 2. Passive Interfaces (Disable OSPF on User-Facing Ports)
```bash
router ospf 1
 passive-interface default
 no passive-interface GigabitEthernet0/1
 no passive-interface GigabitEthernet0/2
```

### 3. Route Filtering
```bash
# Distribute-list (filter routes entering RIB)
access-list 10 deny 192.168.99.0 0.0.0.255
access-list 10 permit any

router ospf 1
 distribute-list 10 in
```

### 4. Limit LSA Propagation (Stub Areas)
```bash
# Configure stub area to block Type 5 LSAs
router ospf 1
 area 10 stub

# All routers in area 10 must be configured as stub
```

## Monitoring OSPF with Tools

### OSPF Debugging
```bash
# Enable OSPF debugging (use sparingly in production)
debug ip ospf adj          # Adjacency formation
debug ip ospf events       # OSPF events
debug ip ospf packet       # OSPF packets (very verbose)

# Disable all debugging
no debug all
undebug all
```

### Packet Capture
```bash
# Capture OSPF packets
sudo tcpdump -i eth0 proto ospf -vv

# Capture OSPF multicast
sudo tcpdump -i eth0 dst 224.0.0.5 or dst 224.0.0.6 -vv
```

### Log Analysis
```bash
# Check syslog for OSPF events
tail -f /var/log/syslog | grep OSPF

# Example events
# %OSPF-5-ADJCHG: Process 1, Nbr 2.2.2.2 on GigabitEthernet0/1 from LOADING to FULL
# %OSPF-4-ERRRCV: Received invalid packet: mismatch area ID
```

## Quick Reference

**Essential OSPF Commands:**
```bash
show ip ospf neighbor              # Neighbor status
show ip ospf interface brief       # OSPF-enabled interfaces
show ip ospf database              # LSDB summary
show ip route ospf                 # OSPF routes in RIB
show ip ospf border-routers        # ABRs and ASBRs
clear ip ospf process              # Restart OSPF (drops all adjacencies)
```

**OSPF Cost Calculation:**
```
Cost = Reference Bandwidth / Interface Bandwidth
- Default reference bandwidth = 100 Mbps
- FastEthernet (100 Mbps): Cost = 100/100 = 1
- GigabitEthernet (1000 Mbps): Cost = 100/1000 = 1 (capped at 1)
- 10G (10000 Mbps): Cost = 100/10000 = 1 (capped at 1)

Solution: Increase reference bandwidth
router ospf 1
 auto-cost reference-bandwidth 100000  # 100 Gbps
```

**OSPF Administrative Distance:**
- OSPF intra-area (O): AD = 110
- OSPF inter-area (O IA): AD = 110
- OSPF external (O E1/E2): AD = 110

**OSPF Multicast Addresses:**
- **224.0.0.5** (AllSPFRouters): All OSPF routers
- **224.0.0.6** (AllDRouters): DR and BDR only

***
# References
1. [RFC 2328 - OSPF Version 2](https://tools.ietf.org/html/rfc2328)
2. [RFC 3101 - OSPF NSSA](https://tools.ietf.org/html/rfc3101)
3. [RFC 5340 - OSPF for IPv6 (OSPFv3)](https://tools.ietf.org/html/rfc5340)
4. Computer Networking: A Top-Down Approach, 8th Edition - James F. Kurose, Keith W. Ross
	1. Chapter 5: Network Layer - The Control Plane
5. [FRRouting OSPF Documentation](https://docs.frrouting.org/en/latest/ospfd.html)
6. [Cisco OSPF Design Guide](https://www.cisco.com/c/en/us/support/docs/ip/open-shortest-path-first-ospf/7039-1.html)
